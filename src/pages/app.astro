---
import Layout from '../layouts/Layout.astro';
import Header from '../components/shared/Header.astro';
import Footer from '../components/shared/Footer.astro';
import ImageUploadArea from '../components/app/ImageUploadArea.astro';
import ProcessingControls from '../components/app/ProcessingControls.astro';
import ImagePreview from '../components/app/ImagePreview.astro';
import DownloadButton from '../components/app/DownloadButton.astro';
---

<Layout
  title="Reshrimp â€” Image Processing App"
  description="Resize, convert, and compress images privately in your browser. No uploads, no tracking."
>
  <div class="page-pop">
    <Header currentPath="/app" />

    <main class="sp-app-main" transition:animate="fade">
      <div class="sp-app-container">
        <!-- App Header -->
        <div class="sp-app-header">
          <span class="pop-chip pop-chip-lavender">100% Private</span>
          <h1 class="sp-app-title">Image Processor</h1>
          <p class="sp-app-subtitle">
            All processing happens on your device. Your images never leave your computer.
          </p>
        </div>

        <!-- Main Content -->
        <div class="sp-app-content">
          <section>
            <ImageUploadArea />
          </section>

          <section>
            <ProcessingControls />
          </section>

          <section>
            <ImagePreview />
          </section>

          <section>
            <DownloadButton />
          </section>
        </div>
      </div>
    </main>

    <Footer />
  </div>
</Layout>

<script>
  import { ImageProcessorController } from '../lib/imageProcessor';

  let controller: ImageProcessorController | null = null;

  function init() {
    if (!document.getElementById('upload-area')) return;
    controller?.cleanup();
    controller = new ImageProcessorController();
  }

  // Initialize on Astro page load (SPA navigation)
  document.addEventListener('astro:page-load', init);

  // Cleanup on navigation away
  document.addEventListener('astro:before-preparation', () => {
    controller?.cleanup();
    controller = null;
  });
</script>

<style>
  .page-pop {
    position: relative;
    min-height: 100vh;
  }

  .sp-app-main {
    padding: 2rem 1.5rem 4rem;
    position: relative;
    z-index: 1;
  }

  .sp-app-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .sp-app-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .sp-app-title {
    font-family: var(--sp-font-display);
    font-size: clamp(1.8rem, 4vw, 2.4rem);
    font-weight: 800;
    margin: 0.75rem 0 0.5rem;
    letter-spacing: -0.02em;
  }

  .sp-app-subtitle {
    font-size: 1rem;
    color: var(--sp-text-muted);
    margin: 0;
  }

  .sp-app-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }
</style>
